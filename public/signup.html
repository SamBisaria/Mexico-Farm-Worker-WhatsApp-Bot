<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Trabajador</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Registro de Trabajador</h1>
    <p class="text-center">Por favor completa tu informaci√≥n para terminar el registro.</p>

    <form id="signupForm" method="POST" action="/signup" class="form-container" style="max-width: 100%;">
      <input type="hidden" name="phone" id="phoneInput" />
      <input type="hidden" name="latitude" id="latitudeInput" />
      <input type="hidden" name="longitude" id="longitudeInput" />

      <div>
        <label for="name">Nombre</label>
        <input type="text" name="name" id="name" required />
      </div>

      <div>
        <label for="age">Edad</label>
        <input type="number" name="age" id="age" min="14" max="120" required />
      </div>

      <div>
        <label for="gender">G√©nero</label>
        <select name="gender" id="gender" required>
          <option value="">-- selecciona --</option>
          <option value="male">Hombre</option>
          <option value="female">Mujer</option>
          <option value="other">Otro</option>
        </select>
      </div>

      <div>
        <label for="experience">A√±os de Experiencia</label>
        <input type="number" name="experience" id="experience" min="0" max="50" placeholder="0" />
      </div>

      <div class="location-box">
        <h3>üìç Ubicaci√≥n</h3>
        <p>Necesitamos tu ubicaci√≥n para recomendarte trabajos cercanos.</p>
        
        <label for="addressInput">Direcci√≥n</label>
        <div class="address-container">
          <input type="text" name="address" id="addressInput" 
                 placeholder="Escribe tu direcci√≥n o usa GPS..."
                 autocomplete="off" required />
          <button type="button" class="gps-btn" onclick="getLocation()">
            üì± GPS
          </button>
          <div id="addressSuggestions"></div>
        </div>
        <div id="locationStatus" class="mt-2" style="font-size: 0.9em; color: var(--text-light);"></div>
      </div>

      <button type="submit" id="submitBtn" disabled>Enviar registro</button>
      <p style="color:var(--danger-color); font-size:0.9em; text-align: center;" id="locationWarning">
        * Por favor selecciona una direcci√≥n de las sugerencias o usa GPS
      </p>
    </form>
  </div>

  <script>
    let searchTimeout;
    let addressValidated = false;

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const phone = getQueryParam('phone');
    if (phone) {
      document.getElementById('phoneInput').value = phone.replace(/[^0-9]/g, '');
    }

    const addressInput = document.getElementById('addressInput');
    const suggestionsDiv = document.getElementById('addressSuggestions');
    const statusEl = document.getElementById('locationStatus');

    function formatAddress(address) {
      const parts = [];
      
      // Street
      if (address.road) {
        let street = address.road;
        if (address.house_number) {
          street = `${address.house_number} ${address.road}`;
        }
        parts.push(street);
      }
      
      // Neighborhood (optional)
      if (address.suburb) parts.push(address.suburb);
      else if (address.neighbourhood) parts.push(address.neighbourhood);
      
      // City
      const city = address.city || address.town || address.village || address.hamlet;
      if (city) parts.push(city);
      
      // State
      if (address.state) parts.push(address.state);
      
      return parts.join(', ');
    }

    function getLocation() {
      statusEl.textContent = 'Obteniendo ubicaci√≥n...';
      
      if (!navigator.geolocation) {
        statusEl.textContent = '‚ùå Tu navegador no soporta geolocalizaci√≥n';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          statusEl.textContent = '‚úÖ Obteniendo direcci√≥n...';
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`, {
              headers: { 'User-Agent': 'SanQuintinJobsApp/1.0' }
            });
            const data = await response.json();
            if (data && data.address) {
              const formatted = formatAddress(data.address);
              addressInput.value = formatted;
              document.getElementById('latitudeInput').value = lat;
              document.getElementById('longitudeInput').value = lng;
              statusEl.textContent = '‚úÖ Ubicaci√≥n obtenida';
              addressValidated = true;
              enableSubmit();
            }
          } catch (err) {
            console.error('Reverse geocoding failed:', err);
            statusEl.textContent = '‚ùå Error obteniendo direcci√≥n';
          }
        },
        (error) => {
          statusEl.textContent = '‚ùå No se pudo obtener la ubicaci√≥n';
          console.error('Geolocation error:', error);
        }
      );
    }

    function enableSubmit() {
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('locationWarning').style.display = 'none';
    }

    addressInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      // Reset validation when user modifies address
      addressValidated = false;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('locationWarning').style.display = 'block';
      document.getElementById('latitudeInput').value = '';
      document.getElementById('longitudeInput').value = '';
      
      clearTimeout(searchTimeout);
      
      if (query.length < 3) {
        suggestionsDiv.style.display = 'none';
        statusEl.textContent = '';
        return;
      }
      
      statusEl.textContent = 'Buscando direcciones...';
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1`, {
            headers: { 'User-Agent': 'SanQuintinJobsApp/1.0' }
          });
          const results = await response.json();
          
          if (results && results.length > 0) {
            suggestionsDiv.innerHTML = results.map(result => {
              const formatted = formatAddress(result.address);
              return `<div class="suggestion-item"
                   data-lat="${result.lat}" 
                   data-lon="${result.lon}" 
                   data-address="${formatted}">
                ${formatted}
              </div>`;
            }).join('');
            suggestionsDiv.style.display = 'block';
            statusEl.textContent = '';
            
            document.querySelectorAll('.suggestion-item').forEach(item => {
              item.addEventListener('click', function() {
                addressInput.value = this.getAttribute('data-address');
                document.getElementById('latitudeInput').value = this.getAttribute('data-lat');
                document.getElementById('longitudeInput').value = this.getAttribute('data-lon');
                
                suggestionsDiv.style.display = 'none';
                statusEl.textContent = '‚úÖ Direcci√≥n seleccionada';
                
                addressValidated = true;
                enableSubmit();
              });
            });
          } else {
            suggestionsDiv.innerHTML = '<div style="padding:0.75rem; color:#999;">No se encontraron direcciones</div>';
            suggestionsDiv.style.display = 'block';
            statusEl.textContent = '';
          }
        } catch (err) {
          console.error('Search error:', err);
          suggestionsDiv.style.display = 'none';
          statusEl.textContent = '‚ùå Error buscando direcciones';
        }
      }, 300);
    });

    document.addEventListener('click', function(e) {
      if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
      }
    });

    document.getElementById('signupForm').addEventListener('submit', function(e) {
      const phoneVal = document.getElementById('phoneInput').value;
      if (!phoneVal) {
        e.preventDefault();
        alert('Falta n√∫mero telef√≥nico. Abre la forma desde el enlace de WhatsApp.');
        return;
      }

      const lat = document.getElementById('latitudeInput').value;
      const lng = document.getElementById('longitudeInput').value;

      if (!lat || !lng || !addressValidated) {
        e.preventDefault();
        alert('Por favor selecciona una direcci√≥n de las sugerencias o usa GPS.');
        return;
      }
    });
  </script>
</body>
</html>