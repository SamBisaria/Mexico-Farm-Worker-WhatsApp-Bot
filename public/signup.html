<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Trabajador</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:600px; margin:2rem auto; padding:1rem; }
    label { display:block; margin-top:0.75rem }
    input, select, textarea { width:100%; padding:0.5rem; margin-top:0.25rem; box-sizing:border-box; }
    button { margin-top:1rem; padding:0.75rem 1rem }
    .location-section { margin-top:1.5rem; padding:1rem; background:#f5f5f5; border-radius:4px; }
    .status { margin-top:0.5rem; font-size:0.9em; color:#666; }
    .address-container { position:relative; }
    .gps-btn { position:absolute; right:5px; top:50%; transform:translateY(-50%); padding:0.4rem 0.6rem; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; }
    .gps-btn:hover { background:#0056b3; }
    #addressSuggestions { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:1000; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .suggestion-item { padding:0.75rem; cursor:pointer; border-bottom:1px solid #eee; }
    .suggestion-item:hover { background:#f0f0f0; }
  </style>
</head>
<body>
  <h1>Registro de Trabajador</h1>
  <p>Por favor completa tu informaci√≥n para terminar el registro.</p>

  <form id="signupForm" method="POST" action="/signup">
    <input type="hidden" name="phone" id="phoneInput" />
    <input type="hidden" name="latitude" id="latitudeInput" />
    <input type="hidden" name="longitude" id="longitudeInput" />

    <label>Nombre
      <input type="text" name="name" id="name" required />
    </label>

    <label>Edad
      <input type="number" name="age" id="age" min="14" max="120" required />
    </label>

    <label>G√©nero
      <select name="gender" id="gender" required>
        <option value="">-- selecciona --</option>
        <option value="male">Hombre</option>
        <option value="female">Mujer</option>
        <option value="other">Otro</option>
      </select>
    </label>

    <label>A√±os de Experiencia
      <input type="number" name="experience" id="experience" min="0" max="50" placeholder="0" />
    </label>

    <div class="location-section">
      <h3>üìç Ubicaci√≥n</h3>
      <p>Necesitamos tu ubicaci√≥n para recomendarte trabajos cercanos.</p>
      
      <label>Direcci√≥n
        <div class="address-container">
          <input type="text" name="address" id="addressInput" 
                 placeholder="Escribe tu direcci√≥n o usa GPS..."
                 autocomplete="off" required />
          <button type="button" class="gps-btn" onclick="getLocation()">
            üì± GPS
          </button>
          <div id="addressSuggestions"></div>
        </div>
        <div id="locationStatus" class="status"></div>
      </label>
    </div>

    <button type="submit" id="submitBtn" disabled>Enviar registro</button>
    <p style="color:red; font-size:0.9em;" id="locationWarning">
      * Por favor selecciona una direcci√≥n de las sugerencias o usa GPS
    </p>
  </form>

  <script>
    let searchTimeout;
    let addressValidated = false;

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const phone = getQueryParam('phone');
    if (phone) {
      document.getElementById('phoneInput').value = phone.replace(/[^0-9]/g, '');
    }

    const addressInput = document.getElementById('addressInput');
    const suggestionsDiv = document.getElementById('addressSuggestions');
    const statusEl = document.getElementById('locationStatus');

    function getLocation() {
      statusEl.textContent = 'Obteniendo ubicaci√≥n...';
      
      if (!navigator.geolocation) {
        statusEl.textContent = '‚ùå Tu navegador no soporta geolocalizaci√≥n';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          statusEl.textContent = '‚úÖ Obteniendo direcci√≥n...';
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`, {
              headers: { 'User-Agent': 'SanQuintinJobsApp/1.0' }
            });
            const data = await response.json();
            if (data && data.display_name) {
              addressInput.value = data.display_name;
              document.getElementById('latitudeInput').value = lat;
              document.getElementById('longitudeInput').value = lng;
              statusEl.textContent = '‚úÖ Ubicaci√≥n obtenida';
              addressValidated = true;
              enableSubmit();
            }
          } catch (err) {
            console.error('Reverse geocoding failed:', err);
            statusEl.textContent = '‚ùå Error obteniendo direcci√≥n';
          }
        },
        (error) => {
          statusEl.textContent = '‚ùå No se pudo obtener la ubicaci√≥n';
          console.error('Geolocation error:', error);
        }
      );
    }

    function enableSubmit() {
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('locationWarning').style.display = 'none';
    }

    addressInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      // Reset validation when user modifies address
      addressValidated = false;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('locationWarning').style.display = 'block';
      document.getElementById('latitudeInput').value = '';
      document.getElementById('longitudeInput').value = '';
      
      clearTimeout(searchTimeout);
      
      if (query.length < 3) {
        suggestionsDiv.style.display = 'none';
        statusEl.textContent = '';
        return;
      }
      
      statusEl.textContent = 'Buscando direcciones...';
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1`, {
            headers: { 'User-Agent': 'SanQuintinJobsApp/1.0' }
          });
          const results = await response.json();
          
          if (results && results.length > 0) {
            suggestionsDiv.innerHTML = results.map(result => 
              `<div class="suggestion-item"
                   data-lat="${result.lat}" 
                   data-lon="${result.lon}" 
                   data-address="${result.display_name}">
                ${result.display_name}
              </div>`
            ).join('');
            suggestionsDiv.style.display = 'block';
            statusEl.textContent = '';
            
            document.querySelectorAll('.suggestion-item').forEach(item => {
              item.addEventListener('click', function() {
                addressInput.value = this.getAttribute('data-address');
                document.getElementById('latitudeInput').value = this.getAttribute('data-lat');
                document.getElementById('longitudeInput').value = this.getAttribute('data-lon');
                
                suggestionsDiv.style.display = 'none';
                statusEl.textContent = '‚úÖ Direcci√≥n seleccionada';
                
                addressValidated = true;
                enableSubmit();
              });
            });
          } else {
            suggestionsDiv.innerHTML = '<div style="padding:0.75rem; color:#999;">No se encontraron direcciones</div>';
            suggestionsDiv.style.display = 'block';
            statusEl.textContent = '';
          }
        } catch (err) {
          console.error('Search error:', err);
          suggestionsDiv.style.display = 'none';
          statusEl.textContent = '‚ùå Error buscando direcciones';
        }
      }, 300);
    });

    document.addEventListener('click', function(e) {
      if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
      }
    });

    document.getElementById('signupForm').addEventListener('submit', function(e) {
      const phoneVal = document.getElementById('phoneInput').value;
      if (!phoneVal) {
        e.preventDefault();
        alert('Falta n√∫mero telef√≥nico. Abre la forma desde el enlace de WhatsApp.');
        return;
      }

      const lat = document.getElementById('latitudeInput').value;
      const lng = document.getElementById('longitudeInput').value;

      if (!lat || !lng || !addressValidated) {
        e.preventDefault();
        alert('Por favor selecciona una direcci√≥n de las sugerencias o usa GPS.');
        return;
      }
    });
  </script>
</body>
</html>